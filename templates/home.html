{% extends "layout.html" %}

{% block content %}

<div class="jumbotron">
  <h1 class="display-4">Proyecto de Machine Learning : Analisis de Ventas 
  </h1>
  <p class="lead">This is a simple hero unit, a simple jumbotron-style component for calling extra attention to featured content or information.</p>
  <hr class="my-4">


  <script type="text/python">
    # Import libraries
    import warnings
    import itertools
    import pandas as pd
    import numpy as np
    import matplotlib.pyplot as plt
    import statsmodels.api as sm
    from datetime import date
    # Defaults
    plt.rcParams['figure.figsize'] = (20.0, 10.0)
    plt.rcParams.update({'font.size': 12})
    plt.style.use('ggplot')
    # Load the data
    data = pd.read_csv('./sample_data/train.csv', engine='python', skipfooter=3)

    data = data.groupby(data.family)
    data = data.get_group("GROCERY I")
    #data = data.get_group("PRODUCE")
    #data = data.get_group("CLEANING")
    data = data.groupby(data.store_nbr)
    data = data.get_group(1)

    data['date']=pd.to_datetime(data['date'], format='%Y-%m-%d')
    data = data.groupby(data['date'].dt.strftime('%Y-%m')).sum().reset_index()

    data = pd.DataFrame(data, columns = ['date','sales'])

    # A bit of pre-processing to make it nicer
    data['date']=pd.to_datetime(data['date'], format='%Y-%m-%d')
    data.set_index(['date'], inplace=True)
    data = data[:-1]
    ass = data.iloc[-1:]
    data = pd.concat([data, ass])
    data.tail(5)
    # Plot the data
    data.plot()
    plt.ylabel('Ventas')
    plt.xlabel('Date')
    plt.show()
    # Define the d and q parameters to take any value between 0 and 1
    q = d = range(0, 1)
    # Definir los parámetros p para tomar cualquier valor entre 0 y 3
    p = range(0, 3)

    # Generate all different combinations of p, q and q triplets
    pdq = list(itertools.product(p, d, q))

    # Generate all different combinations of seasonal p, q and q triplets
    seasonal_pdq = [(x[0], x[1], x[2], 12) for x in list(itertools.product(p, d, q))]

    print('Examples of parameter combinations for Seasonal ARIMA...')
    print('SARIMAX: {} x {}'.format(pdq[1], seasonal_pdq[1]))
    #print('SARIMAX: {} x {}'.format(pdq[1], seasonal_pdq[2]))
    #print('SARIMAX: {} x {}'.format(pdq[2], seasonal_pdq[3]))
    #print('SARIMAX: {} x {}'.format(pdq[2], seasonal_pdq[4]))
    train_data = data['2013-01-01':'2016-12-01']
    test_data = data['2017-01-01':'2017-02-01']
    #train_data = data['2013-03-01':'2015-08']
    #test_data = data['2017-01':'2017-08-01']
    print('El AIC más pequeño es {} para el modelo SARIMAX{}x{}'.format(min(AIC), SARIMAX_model[AIC.index(min(AIC))][0],SARIMAX_model[AIC.index(min(AIC))][1]))
    # Let's fit this model
    mod = sm.tsa.statespace.SARIMAX(train_data,
                                    order=SARIMAX_model[AIC.index(min(AIC))][0],
                                    seasonal_order=SARIMAX_model[AIC.index(min(AIC))][1],
                                    enforce_stationarity=False,
                                    enforce_invertibility=False)

    results = mod.fit()
    results.plot_diagnostics(figsize=(20, 14))
    plt.show()

    pred0 = results.get_prediction(start='2015-01-01', dynamic=False) #un anio antes del train data 
    pred0_ci = pred0.conf_int()
    pred0_ci
    pred1 = results.get_prediction(start='2015-01-01', dynamic=True) #un anio antes del train data 
    pred1_ci = pred1.conf_int()
    #pred1_ci
    pred2 = results.get_forecast('2018-12-01') #anios no conocidos 
    pred2_ci = pred2.conf_int()
    pred2_ci
    #print(pred2.predicted_mean['2015-11-01':'2015-11-30'])
    # DATA VISUALIZATION
    # ------------------------------------------------------
    import matplotlib.pyplot as plt
    import seaborn as sns
    import plotly.express as px
    from sklearn import linear_model
    import plotly.graph_objects as go
    
    #pr1
    lst1 = pred0.predicted_mean
    pr1 = pd.DataFrame(lst1,columns=['sales'])
    pr1.reset_index(inplace=True)
    pr1 = pr1.rename(columns = {'index':'date'})
    
    #pr2
    lst2 = pred1.predicted_mean
    pr2 = pd.DataFrame(lst2,columns=['sales'])
    pr2.reset_index(inplace=True)
    pr2 = pr2.rename(columns = {'index':'date'})
    #print(pr2)
    
    #pr3
    lst3 = pred2.predicted_mean
    pr3 = pd.DataFrame(lst3,columns=['sales'])
    pr3.reset_index(inplace=True)
    pr3 = pr3.rename(columns = {'index':'date'})
    #pr3 = pr3.rename(columns = {'index':'date','upper sales':'sales'})
    
    #all_sales
    all_sales = pd.DataFrame(data,columns=['sales'])
    all_sales.reset_index(inplace=True)
    all_sales = all_sales.rename(columns = {'index':'date'})
    
    #relleno
    lst4 = pred2_ci.iloc[:, 0]
    pr4 = pd.DataFrame(lst4)
    pr4.reset_index(inplace=True)
    pr4 = pr4.rename(columns = {'index':'date','lower sales':'sales'})
    
    #relleno
    lst5 = pred2_ci.iloc[:, 1]
    pr5 = pd.DataFrame(lst5)
    pr5.reset_index(inplace=True)
    pr5 = pr5.rename(columns = {'index':'date','upper sales':'sales'})
    
    
    fig = go.Figure()
    plt.figure(figsize=(40, 40))
    fig.add_trace(go.Scatter(x=all_sales.date, y=all_sales.sales ,name = 'Ventas Totales',))
    fig.add_trace(go.Scatter(x=pr1.date, y=pr1.sales ,name = 'Pronóstico de 1 paso adelante',))
    fig.add_trace(go.Scatter(x=pr2.date, y=pr2.sales ,name = 'Pronóstico dinámico',))
    fig.add_trace(go.Scatter(x=pr3.date, y=pr3.sales ,name = 'Pronóstico dinámico Futuro',))
    fig.add_trace(go.Scatter(x=pr4.date, y=pr4.sales,name = 'Lower Sales',fill=None,mode='lines',line_color='indigo',))
    fig.add_trace(go.Scatter(x=pr5.date, y=pr5.sales,name = 'Upper Sales',fill='tonexty',mode='lines', line_color='indigo'))
    fig.show()
    prediction = pred2.predicted_mean['2017-01-01':'2017-02-01'].values
    truth = list(itertools.chain.from_iterable(test_data.values))
    #Mean Absolute Percentage Error
    MAPE = np.mean(np.abs((truth - prediction) / truth)) * 100
    print('El error porcentual absoluto medio para el pronóstico del año 2017 mes de Enero es {:.2f}%'.format(MAPE))
    print(truth)
    print(prediction)












  </script>







  <p>It uses utility classes for typography and spacing to space content out within the larger container.</p>
  <a class="btn btn-primary btn-lg" href="#" role="button">Learn more</a>
</div>

{% endblock%}
